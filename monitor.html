<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Renard's Roost Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxuvwv/b4jzlGC62Q==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            color-scheme: light;
            --accent: #34b3d3;
            --accent-strong: #0284c7;
            --accent-dark: #1e3a8a;
            --accent-soft: rgba(2, 132, 199, 0.12);
            --card-bg: #f0f9ff;
            --card-border: rgba(2, 132, 199, 0.2);
        }

        html, body {
            width: 100%;
            overflow-x: hidden;
        }

        body {
            font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            background: linear-gradient(125deg, #e0f2fe 0%, #bae6fd 45%, #ffffff 100%);
            color: #083344;
        }

        .glass-card {
            background: rgba(240, 249, 255, 0.94);
            backdrop-filter: blur(22px);
            border: 1px solid var(--card-border);
            box-shadow: 0 28px 55px -28px rgba(2, 132, 199, 0.35);
        }

        .rate-calendar {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            overflow: hidden;
            border-radius: 18px;
            box-shadow: inset 0 0 0 1px rgba(2, 132, 199, 0.15);
        }

        .rate-calendar th {
            background: linear-gradient(120deg, rgba(2, 132, 199, 0.94), rgba(2, 132, 199, 0.82));
            color: #e0f2fe;
            font-weight: 600;
            padding: 14px 8px;
            font-size: 13px;
            letter-spacing: 0.04em;
            text-transform: uppercase;
        }

        .rate-calendar td {
            width: 14.2857%;
            text-align: center;
            padding: 16px 8px;
            font-size: 13px;
            border: 1px solid rgba(226, 232, 240, 0.65);
            background: rgba(240, 249, 255, 0.95);
            transition: transform 0.18s ease, background 0.18s ease, box-shadow 0.18s ease;
            cursor: pointer;
        }

        .rate-calendar td:hover {
            background: rgba(2, 132, 199, 0.18);
            transform: translateY(-2px);
            box-shadow: 0 8px 22px -16px rgba(2, 132, 199, 0.35);
        }

        .rate-calendar td.past {
            background: rgba(241, 245, 249, 0.9);
            color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .rate-calendar td.past:hover {
            background: rgba(241, 245, 249, 0.9);
        }

        .calendar-day {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            min-height: 64px;
            justify-content: center;
        }

        .calendar-day-num {
            font-weight: 600;
            font-size: 14px;
            color: #0f172a;
        }

        .calendar-day-price {
            font-size: 12px;
            color: var(--accent-strong);
            font-weight: 600;
        }

        .rate-calendar td.custom-rate .calendar-day-price {
            color: var(--accent-dark);
        }

        .dashboard-backdrop {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
        }

        .dashboard-backdrop div {
            position: absolute;
            border-radius: 9999px;
            filter: blur(120px);
            opacity: 0.65;
        }

        .dashboard-backdrop div:nth-child(1) {
            width: 540px;
            height: 540px;
            background: rgba(2, 132, 199, 0.32);
            top: -120px;
            left: -140px;
        }

        .dashboard-backdrop div:nth-child(2) {
            width: 480px;
            height: 480px;
            background: rgba(125, 211, 252, 0.28);
            bottom: -160px;
            right: -120px;
        }

        .dashboard-backdrop div:nth-child(3) {
            width: 380px;
            height: 380px;
            background: rgba(147, 197, 253, 0.24);
            top: 38%;
            right: 28%;
        }

        .bg-blue-500 {
            background-color: var(--accent) !important;
        }

        .hover\:bg-blue-600:hover {
            background-color: var(--accent-dark) !important;
        }

        .bg-blue-50 {
            background-color: var(--accent-soft) !important;
        }

        .text-blue-600 {
            color: var(--accent-strong) !important;
        }

        .text-blue-700 {
            color: var(--accent-dark) !important;
        }

        .border-blue-200 {
            border-color: rgba(2, 132, 199, 0.42) !important;
        }

        .border-blue-200\/60 {
            border-color: rgba(2, 132, 199, 0.28) !important;
        }

        .border-blue-100\/60 {
            border-color: rgba(2, 132, 199, 0.18) !important;
        }

        .border-blue-600 {
            border-color: var(--accent-strong) !important;
        }

        .ring-blue-200 {
            --tw-ring-color: rgba(2, 132, 199, 0.28) !important;
        }

        .ring-blue-100 {
            --tw-ring-color: rgba(2, 132, 199, 0.18) !important;
        }

        .shadow-blue-500\/40 {
            box-shadow: 0 18px 48px rgba(2, 132, 199, 0.32) !important;
        }

        .shadow-blue-500\/30 {
            box-shadow: 0 18px 42px rgba(2, 132, 199, 0.24) !important;
        }

        .shadow-blue-500\/20 {
            box-shadow: 0 12px 28px rgba(2, 132, 199, 0.18) !important;
        }

        .hover\:bg-blue-50:hover {
            background-color: rgba(2, 132, 199, 0.12) !important;
        }

        .focus\:border-blue-400:focus {
            border-color: rgba(2, 132, 199, 0.7) !important;
            box-shadow: 0 0 0 3px rgba(2, 132, 199, 0.2);
        }

        .focus\:ring-blue-100:focus {
            --tw-ring-color: rgba(2, 132, 199, 0.25) !important;
        }
    </style>
</head>
<body class="relative text-slate-700">
    <div class="dashboard-backdrop" aria-hidden="true">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div class="relative z-10">
        <nav class="max-w-6xl mx-auto px-6 pt-8">
            <div class="glass-card rounded-3xl px-6 py-5 flex flex-col gap-4 sm:flex-row sm:items-center sm:justify-between">
                <a href="index.html" class="flex items-center gap-3">
                    <span class="inline-flex h-12 w-12 items-center justify-center rounded-2xl bg-blue-500 text-white text-lg font-semibold tracking-tight shadow-lg shadow-blue-500/40">RR</span>
                    <div>
                        <p class="text-xs uppercase tracking-[0.35em] text-blue-700">Renard's Roost</p>
                        <p class="text-base font-semibold text-slate-900">Booking Admin Center</p>
                    </div>
                </a>
                <div class="flex flex-wrap items-center gap-3 text-sm">
                    <span id="userInfo" class="rounded-full bg-blue-50 px-3 py-1 text-blue-700 border border-blue-200/60"></span>
                    <button id="logoutBtn" onclick="logout()" class="rounded-full border border-red-200 px-3 py-1 text-red-600 transition hover:bg-red-50"><i class="fas fa-sign-out-alt mr-1"></i>Logout</button>
                </div>
            </div>
        </nav>
        <main id="adminHub" class="max-w-6xl mx-auto px-6 mt-16 pb-20">
            <div class="glass-card rounded-3xl p-6 md:p-8 space-y-8">
                <div class="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
                    <div>
                        <h2 class="text-3xl font-semibold text-slate-900">Control Center</h2>
                        <p class="text-sm text-slate-500">Track bookings, adjust prices and create attractive service packages.</p>
                    </div>
                    <p class="text-xs uppercase tracking-[0.4em] text-blue-600">Clear & blue vibe</p>
                </div>
                <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-4">
                    <div class="rounded-2xl bg-white/85 p-6 shadow-sm ring-1 ring-blue-100/60">
                        <h3 class="text-sm font-medium text-slate-500">Total Bookings</h3>
                        <p class="mt-1 text-2xl font-semibold text-slate-900" id="totalBookings">0</p>
                    </div>
                    <div class="rounded-2xl bg-white/85 p-6 shadow-sm ring-1 ring-blue-100/60">
                        <h3 class="text-sm font-medium text-slate-500">Revenue</h3>
                        <p class="mt-1 text-2xl font-semibold text-slate-900" id="totalRevenue">0 VND</p>
                    </div>
                    <div class="rounded-2xl bg-white/85 p-6 shadow-sm ring-1 ring-blue-100/60">
                        <h3 class="text-sm font-medium text-slate-500">Upcoming Bookings</h3>
                        <p class="mt-1 text-2xl font-semibold text-slate-900" id="upcomingBookings">0</p>
                    </div>
                    <div class="rounded-2xl bg-white/85 p-6 shadow-sm ring-1 ring-blue-100/60">
                        <h3 class="text-sm font-medium text-slate-500">Add-on Products</h3>
                        <p class="mt-1 text-2xl font-semibold text-slate-900" id="totalProducts">0</p>
                    </div>
                </div>
                <div class="relative h-64">
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="flex flex-col lg:flex-row gap-8">
                    <aside class="w-full lg:w-64 flex-shrink-0">
                        <nav class="flex flex-col gap-2">
                            <button onclick="showTab('bookingsTab')" id="btnBookings" class="flex items-center gap-2 rounded-xl px-4 py-3 text-left text-sm font-medium transition bg-blue-500 text-white shadow-sm">
                                <i class="fas fa-book-open"></i> Bookings
                            </button>
                            <button onclick="showTab('productsTab')" id="btnProducts" class="flex items-center gap-2 rounded-xl px-4 py-3 text-left text-sm font-medium transition text-slate-500 hover:text-blue-600">
                                <i class="fas fa-concierge-bell"></i> Assets
                            </button>
                        </nav>
                    </aside>
                    <div class="flex-1">
                        <section id="bookingsTab" class="space-y-8">
                            <div class="grid gap-6 xl:grid-cols-[minmax(0,420px),1fr]">
                                <div class="rounded-3xl border border-blue-200/60 bg-white/85 p-6 shadow-lg shadow-blue-500/10">
                                    <div class="flex flex-wrap items-center justify-between gap-3">
                                        <h3 class="text-lg font-semibold text-slate-900">Daily Price Calendar</h3>
                                        <div class="flex items-center gap-2">
                                            <button id="ratePrev" class="flex h-8 w-8 items-center justify-center rounded-full border border-blue-200 text-blue-600 transition hover:bg-blue-50">&lt;</button>
                                            <span id="rateMonthLabel" class="text-sm font-medium text-slate-500 min-w-[120px] text-center"></span>
                                            <button id="rateNext" class="flex h-8 w-8 items-center justify-center rounded-full border border-blue-200 text-blue-600 transition hover:bg-blue-50">&gt;</button>
                                        </div>
                                    </div>
                                    <p class="pt-2 text-xs text-slate-500">Select date to enter custom price. Leave blank to return to base price.</p>
                                    <div class="mt-4 overflow-hidden rounded-2xl ring-1 ring-blue-100">
                                        <table class="rate-calendar">
                                            <thead>
                                                <tr>
                                                    <th>Su</th>
                                                    <th>Mo</th>
                                                    <th>Tu</th>
                                                    <th>We</th>
                                                    <th>Th</th>
                                                    <th>Fr</th>
                                                    <th>Sa</th>
                                                </tr>
                                            </thead>
                                            <tbody id="rateCalendarBody"></tbody>
                                        </table>
                                    </div>
                                    <p class="mt-3 text-xs text-blue-700">* Blue dates show custom prices.</p>
                                </div>
                                <div class="rounded-3xl border border-slate-200/70 bg-white/90 shadow-xl shadow-slate-900/5 overflow-hidden">
                                    <div class="flex flex-wrap items-center justify-between gap-3 bg-slate-900/95 px-6 py-5 text-white">
                                        <div>
                                            <h3 class="text-lg font-semibold">Booking list</h3>
                                            <p class="text-xs text-slate-200">Monitor guests, stay windows, and payment values in one glance.</p>
                                        </div>
                                        <button onclick="reloadAllBookings()" class="rounded-full bg-white/90 px-4 py-2 text-xs font-semibold text-slate-900 transition hover:bg-blue-100 hover:text-blue-700"><i class="fas fa-sync-alt mr-1"></i>Refresh</button>
                                    </div>
                                    <div class="overflow-auto">
                                        <table class="min-w-full divide-y divide-slate-200 text-sm">
                                            <thead class="bg-slate-100/90 text-slate-600">
                                                <tr>
                                                    <th class="px-5 py-3 text-left font-medium uppercase tracking-wide text-[11px]">ID</th>
                                                    <th class="px-5 py-3 text-left font-medium uppercase tracking-wide text-[11px]">Email</th>
                                                    <th class="px-5 py-3 text-left font-medium uppercase tracking-wide text-[11px]">Start</th>
                                                    <th class="px-5 py-3 text-left font-medium uppercase tracking-wide text-[11px]">End</th>
                                                    <th class="px-5 py-3 text-left font-medium uppercase tracking-wide text-[11px]">Guests</th>
                                                    <th class="px-5 py-3 text-left font-medium uppercase tracking-wide text-[11px]">Value</th>
                                                </tr>
                                            </thead>
                                            <tbody id="allBookings" class="divide-y divide-slate-100 bg-white/95"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </section>
                        <section id="productsTab" class="hidden space-y-6">
                            <div class="flex flex-wrap items-center justify-between gap-3">
                                <div>
                                    <h3 class="text-lg font-semibold text-slate-900">Add-on services & products</h3>
                                    <p class="text-xs text-slate-500">Curate dining, activities, and keepsakes to elevate the stay.</p>
                                </div>
                                <button onclick="openAddProductModal()" class="rounded-full bg-blue-500 px-4 py-2 text-sm font-semibold text-white shadow-lg shadow-blue-500/30 transition hover:-translate-y-0.5 hover:bg-blue-600"><i class="fas fa-plus mr-1"></i>Add service</button>
                            </div>
                            <div id="productsList" class="grid gap-5 md:grid-cols-2 xl:grid-cols-3"></div>
                        </section>
                    </div>
                </div>
            </div>
        </main>
        <div id="productModal" class="fixed inset-0 hidden bg-slate-900/40 backdrop-blur-sm z-50 flex items-center justify-center px-4">
            <div class="glass-card w-full max-w-lg rounded-3xl p-6 md:p-8 relative">
                <button onclick="closeProductModal()" class="absolute right-5 top-5 text-slate-400 transition hover:text-slate-600"><i class="fas fa-times"></i></button>
                <h3 id="productModalTitle" class="text-xl font-semibold text-slate-900 mb-4">Create a new add-on</h3>
                <form id="productForm" class="space-y-4">
                    <input type="hidden" id="productId">
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div class="flex flex-col gap-2">
                            <label for="mainType" class="text-xs font-medium uppercase tracking-wide text-slate-500">Main Type</label>
                            <input type="text" id="mainType" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="Private Dinner" required/>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label for="subType" class="text-xs font-medium uppercase tracking-wide text-slate-500">Sub Type</label>
                            <input type="text" id="subType" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="Saturday BBQ"/>
                        </div>
                    </div>
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div class="flex flex-col gap-2">
                            <label for="price" class="text-xs font-medium uppercase tracking-wide text-slate-500">Price</label>
                            <input type="number" id="price" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="1250000"/>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label for="quantityType" class="text-xs font-medium uppercase tracking-wide text-slate-500">Unit</label>
                            <input type="text" id="quantityType" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="/package"/>
                        </div>
                    </div>
                    <div class="grid gap-4 sm:grid-cols-2">
                        <div class="flex flex-col gap-2">
                            <label for="priceStart" class="text-xs font-medium uppercase tracking-wide text-slate-500">Effective From</label>
                            <input type="date" id="priceStart" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100"/>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label for="imageFile" class="text-xs font-medium uppercase tracking-wide text-slate-500">Upload Image</label>
                            <input type="file" id="imageFile" accept="image/*" class="block w-full rounded-2xl border border-dashed border-blue-300 bg-blue-50/40 px-4 py-2 text-sm text-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-200"/>
                        </div>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label for="description" class="text-xs font-medium uppercase tracking-wide text-slate-500">Short Description</label>
                        <textarea id="description" rows="3" class="w-full rounded-2xl border border-slate-200 bg-white/90 px-4 py-2 text-sm focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-100" placeholder="Describe the experience or benefits..."></textarea>
                    </div>
                    <div class="flex flex-col gap-2">
                        <span class="text-xs font-medium uppercase tracking-wide text-slate-500">Preview</span>
                        <img id="imagePreview" src="" alt="Preview" class="hidden h-32 w-full rounded-2xl object-cover shadow-inner"/>
                    </div>
                    <div class="pt-2">
                        <button type="submit" class="w-full rounded-full bg-blue-500 px-4 py-3 text-sm font-semibold text-white shadow-lg shadow-blue-500/30 transition hover:-translate-y-0.5 hover:bg-blue-600">Save Service</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = "https://hiiennggithubio-production.up.railway.app";
        const IMAGEKIT_URL = "https://upload.imagekit.io/api/v1/files/upload";
        const IMAGEKIT_PUBLIC_KEY = "your_imagekit_public_key"; // Replace with actual ImageKit.io public key
        let rateMonth = new Date().getMonth();
        let rateYear = new Date().getFullYear();
        let baseNightlyRate = 0;
        let monitorDailyRates = {};
        let chartInstance = null;
        let productImageData = null;
        let editingProductId = null;

        const translations = {
            en: {
                customPricePrompt: (iso, baseLabel) => `Custom price for ${iso} (VND). Leave blank to return to ${baseLabel} VND.`,
                invalidPriceAlert: 'Please enter a valid price.',
                saveErrorAlert: 'Cannot save price',
                deleteErrorAlert: 'Cannot delete price',
                connectionErrorAlert: 'Connection error',
                errorAlert: 'An error occurred',
                loading: 'Loading...',
                noBookings: 'No bookings yet',
                loadingServices: 'Loading services list...',
                noServices: 'No services yet. Add the first package to inspire.',
                serverError: 'Cannot connect to server.',
                imageUploadError: 'Failed to upload image.',
            }
        };

        function getToken() {
            return localStorage.getItem("access_token") || '';
        }

        function getEmail() {
            return localStorage.getItem("user_email") || '';
        }

        function logout() {
            localStorage.clear();
            location.href = 'index.html';
        }

        function showTab(tab) {
            const tabs = ["bookingsTab", "productsTab"];
            tabs.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add("hidden");
            });
            const tabEl = document.getElementById(tab);
            if (tabEl) tabEl.classList.remove("hidden");

            const buttons = ["btnBookings", "btnProducts"];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                if (btn) {
                    btn.classList.remove("bg-blue-500", "text-white");
                    btn.classList.add("text-slate-500");
                }
            });
            const activeBtn = tab === "bookingsTab" ? "btnBookings" : "btnProducts";
            const btn = document.getElementById(activeBtn);
            if (btn) {
                btn.classList.add("bg-blue-500", "text-white");
                btn.classList.remove("text-slate-500");
            }
        }

        async function monitorLoadRate() {
            try {
                const res = await fetch(`${API_BASE}/rate`, {
                    headers: { "Authorization": `Bearer ${getToken()}` }
                });
                const data = await res.json();
                baseNightlyRate = res.ok ? parseFloat(data.nightly_rate) || 500000 : 500000;
            } catch (error) {
                console.error('Error loading rate:', error);
                baseNightlyRate = 500000;
            }
        }

        async function monitorLoadDailyRates() {
            try {
                const res = await fetch(`${API_BASE}/daily-rates`, {
                    headers: { "Authorization": `Bearer ${getToken()}` }
                });
                const data = await res.json();
                monitorDailyRates = {};
                if (res.ok && Array.isArray(data)) {
                    data.forEach(entry => {
                        if (entry?.rate_date && entry?.price !== undefined && entry?.price !== null) {
                            const val = parseFloat(entry.price);
                            if (!isNaN(val)) monitorDailyRates[entry.rate_date] = val;
                        }
                    });
                }
            } catch (error) {
                console.error('Error loading daily rates:', error);
                monitorDailyRates = {};
            }
        }

        function monitorGetPriceForDay(iso) {
            if (!iso) return baseNightlyRate;
            const override = monitorDailyRates[iso];
            return override !== undefined && override !== null ? override : baseNightlyRate;
        }

        function renderRateCalendar() {
            try {
                const body = document.getElementById("rateCalendarBody");
                const label = document.getElementById("rateMonthLabel");
                if (!body || !label) return;
                label.textContent = new Date(rateYear, rateMonth, 1).toLocaleString("en-US", { month: "long", year: "numeric" });
                const first = new Date(rateYear, rateMonth, 1);
                const last = new Date(rateYear, rateMonth + 1, 0);
                const firstWeekday = first.getDay();
                const days = last.getDate();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                let html = "";
                let dayCounter = 1;
                const cells = Math.ceil((firstWeekday + days) / 7) * 7;
                for (let i = 0; i < cells; i++) {
                    if (i % 7 === 0) html += "<tr>";
                    if (i < firstWeekday || dayCounter > days) {
                        html += "<td></td>";
                    } else {
                        const cur = new Date(rateYear, rateMonth, dayCounter);
                        cur.setHours(0, 0, 0, 0);
                        const iso = cur.toISOString().split("T")[0];
                        const isPast = cur < today;
                        const hasCustom = Object.prototype.hasOwnProperty.call(monitorDailyRates, iso);
                        const price = monitorGetPriceForDay(iso);
                        const priceLabel = price ? price.toLocaleString("en-US") + " VND" : "";
                        const cls = [isPast ? "past" : "", hasCustom ? "custom-rate" : ""].filter(Boolean).join(" ");
                        html += `<td class="${cls}" data-iso="${iso}">
                                    <div class="calendar-day">
                                        <div class="calendar-day-num">${dayCounter}</div>
                                        <div class="calendar-day-price">${priceLabel}</div>
                                    </div>
                                 </td>`;
                        dayCounter++;
                    }
                    if (i % 7 === 6) html += "</tr>";
                }
                body.innerHTML = html;
                [...body.querySelectorAll("td[data-iso]")].forEach(td => {
                    const iso = td.getAttribute("data-iso");
                    if (!iso || td.classList.contains("past")) return;
                    td.addEventListener("click", () => handleRateDayClick(iso));
                });
            } catch (error) {
                console.error('Error rendering rate calendar:', error);
            }
        }

        async function handleRateDayClick(iso) {
            try {
                const t = translations.en;
                const existing = monitorDailyRates[iso] || "";
                const baseLabel = baseNightlyRate.toLocaleString("en-US");
                const promptVal = prompt(t.customPricePrompt(iso, baseLabel), existing);
                if (promptVal === null) return;
                const value = promptVal.trim();
                if (value === "") {
                    const res = await fetch(`${API_BASE}/daily-rates/${iso}`, {
                        method: "DELETE",
                        headers: { "Authorization": `Bearer ${getToken()}` }
                    });
                    if (!res.ok) {
                        const data = await res.json().catch(() => ({}));
                        alert(data.detail || t.deleteErrorAlert);
                        return;
                    }
                } else {
                    const normalized = value.replace(/[^0-9]/g, "");
                    const num = parseFloat(normalized);
                    if (isNaN(num) || num <= 0) {
                        alert(t.invalidPriceAlert);
                        return;
                    }
                    const res = await fetch(`${API_BASE}/daily-rates`, {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${getToken()}`
                        },
                        body: JSON.stringify({ rate_date: iso, price: num })
                    });
                    if (!res.ok) {
                        const data = await res.json().catch(() => ({}));
                        alert(data.detail || t.saveErrorAlert);
                        return;
                    }
                }
                await monitorLoadDailyRates();
                renderRateCalendar();
            } catch (error) {
                console.error('Error handling rate day click:', error);
                alert(translations.en.connectionErrorAlert);
            }
        }

        function bindRateCalendarNav() {
            try {
                const prev = document.getElementById("ratePrev");
                const next = document.getElementById("rateNext");
                if (prev) prev.addEventListener("click", () => {
                    rateMonth--;
                    if (rateMonth < 0) { rateMonth = 11; rateYear--; }
                    renderRateCalendar();
                });
                if (next) next.addEventListener("click", () => {
                    rateMonth++;
                    if (rateMonth > 11) { rateMonth = 0; rateYear++; }
                    renderRateCalendar();
                });
            } catch (error) {
                console.error('Error binding rate calendar navigation:', error);
            }
        }

        async function initRateCalendar() {
            try {
                bindRateCalendarNav();
                await monitorLoadRate();
                await monitorLoadDailyRates();
                renderRateCalendar();
            } catch (error) {
                console.error('Error initializing rate calendar:', error);
            }
        }

        async function reloadAllBookings() {
            const wrap = document.getElementById("allBookings");
            if (!wrap) return;
            const t = translations.en;
            wrap.innerHTML = `<tr><td colspan="6" class="p-3 text-slate-500">${t.loading}</td></tr>`;
            try {
                const res = await fetch(`${API_BASE}/all-bookings`, {
                    headers: { "Authorization": `Bearer ${getToken()}` }
                });
                const data = await res.json();
                if (!res.ok) {
                    wrap.innerHTML = `<tr><td colspan="6" class="p-3 text-red-600">${data.detail || t.errorAlert}</td></tr>`;
                    return;
                }
                if (!data.length) {
                    wrap.innerHTML = `<tr><td colspan="6" class="p-3 text-slate-400">${t.noBookings}</td></tr>`;
                    return;
                }
                let totalRevenue = 0;
                wrap.innerHTML = data.map(b => {
                    if (b.payment_value) totalRevenue += parseFloat(b.payment_value);
                    return `
                        <tr>
                            <td class="px-4 py-2">${b.booking_id}</td>
                            <td class="px-4 py-2">${b.email}</td>
                            <td class="px-4 py-2">${b.start_date}</td>
                            <td class="px-4 py-2">${b.end_date}</td>
                            <td class="px-4 py-2">${b.no_visitors ?? '-'}</td>
                            <td class="px-4 py-2">${b.payment_value ? parseFloat(b.payment_value).toLocaleString('en-US') + ' VND' : '-'}</td>
                        </tr>
                    `;
                }).join("");
                const totalBookingsEl = document.getElementById('totalBookings');
                const totalRevenueEl = document.getElementById('totalRevenue');
                const upcomingBookingsEl = document.getElementById('upcomingBookings');
                if (totalBookingsEl) totalBookingsEl.textContent = data.length;
                if (totalRevenueEl) totalRevenueEl.textContent = totalRevenue.toLocaleString('en-US') + ' VND';
                if (upcomingBookingsEl) {
                    const today = new Date();
                    const upcoming = data.filter(b => new Date(b.start_date) >= today).length;
                    upcomingBookingsEl.textContent = upcoming;
                }
            } catch (error) {
                console.error('Error reloading bookings:', error);
                wrap.innerHTML = `<tr><td colspan="6" class="p-3 text-red-600">${t.connectionErrorAlert}</td></tr>`;
            }
        }

        async function loadProducts() {
            const wrap = document.getElementById("productsList");
            const totalProductsEl = document.getElementById('totalProducts');
            if (!wrap || !totalProductsEl) return;
            const t = translations.en;
            wrap.innerHTML = `<p class='rounded-3xl border border-dashed border-blue-200 bg-white/60 px-4 py-6 text-center text-sm text-blue-600'>${t.loadingServices}</p>`;
            try {
                const res = await fetch(`${API_BASE}/products`, {
                    headers: { "Authorization": `Bearer ${getToken()}` }
                });
                const data = await res.json();
                if (!res.ok) {
                    wrap.innerHTML = `<p class='rounded-2xl border border-red-200 bg-white/70 px-4 py-5 text-center text-sm text-red-600'>${data.detail || t.errorAlert}</p>`;
                    totalProductsEl.textContent = '0';
                    return;
                }
                if (!Array.isArray(data) || !data.length) {
                    wrap.innerHTML = `<p class='rounded-2xl border border-slate-200 bg-white/70 px-4 py-6 text-center text-sm text-slate-400'>${t.noServices}</p>`;
                    totalProductsEl.textContent = '0';
                    return;
                }
                wrap.innerHTML = data.map(p => {
                    const imgSrc = p.image_url || 'https://images.unsplash.com/photo-1505691723518-36a5ac3be353?auto=format&fit=crop&w=900&q=70';
                    const priceValue = Number.isFinite(Number(p.price)) ? Number(p.price) : null;
                    const priceLabel = priceValue !== null ? priceValue.toLocaleString('en-US') + ' VND' : '-';
                    const quantityLabel = p.quantity_type ? ' ' + p.quantity_type : '';
                    const start = p.price_start_date ?? '-';
                    const description = p.description ?? '';
                    const title = p.main_type + (p.sub_type ? ' - ' + p.sub_type : '');
                    return `
                        <article class="group relative overflow-hidden rounded-3xl border border-blue-100/60 bg-white/85 shadow-lg shadow-blue-500/10 flex flex-col">
                            <div class="relative h-48 overflow-hidden">
                                <img src="${imgSrc}" alt="${title}" class="h-full w-full object-cover transition duration-500 group-hover:scale-105" loading="lazy"/>
                                <div class="absolute inset-x-0 bottom-0 bg-gradient-to-t from-black/65 to-transparent px-5 pb-4 pt-12 text-white">
                                    <h4 class="text-lg font-semibold">${title}</h4>
                                </div>
                            </div>
                            <div class="flex flex-1 flex-col gap-2 px-5 py-4 text-sm text-slate-600">
                                <p class="text-base font-semibold text-blue-600">${priceLabel}${quantityLabel}</p>
                                <p class="text-xs uppercase tracking-wide text-slate-400">Effective from: ${start}</p>
                                <p class="text-sm text-slate-600">${description}</p>
                                <div class="mt-auto pt-3 flex gap-2">
                                    <button onclick="openAddProductModal(${p.product_id})" class="flex-1 rounded-full border border-blue-200 bg-white px-4 py-2 text-xs font-semibold text-blue-600 transition hover:bg-blue-50"><i class="fas fa-edit mr-1"></i>Edit</button>
                                    <button onclick="deleteProduct(${p.product_id})" class="flex-1 rounded-full border border-red-200 bg-white px-4 py-2 text-xs font-semibold text-red-600 transition hover:bg-red-50"><i class="fas fa-trash mr-1"></i>Delete</button>
                                </div>
                            </div>
                        </article>`;
                }).join("");
                totalProductsEl.textContent = data.length;
            } catch (error) {
                console.error('Error loading products:', error);
                wrap.innerHTML = `<p class='rounded-2xl border border-red-200 bg-white/70 px-4 py-5 text-center text-sm text-red-600'>${t.serverError}</p>`;
                totalProductsEl.textContent = '0';
            }
        }

        async function uploadImageToImageKit(file) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('fileName', file.name);
                formData.append('publicKey', IMAGEKIT_PUBLIC_KEY);
                formData.append('folder', '/renards-roost/products');
                
                const res = await fetch(IMAGEKIT_URL, {
                    method: 'POST',
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) {
                    throw new Error(data.message || translations.en.imageUploadError);
                }
                return {
                    url: data.url,
                    fileId: data.fileId,
                    filename: data.name
                };
            } catch (error) {
                console.error('Error uploading image to ImageKit:', error);
                throw error;
            }
        }

        async function saveImageToDatabase(imageData, productId, mainType, subType) {
            try {
                const res = await fetch(`${API_BASE}/images`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${getToken()}`
                    },
                    body: JSON.stringify({
                        main_group: mainType,
                        sub_group: subType || null,
                        url: imageData.url,
                        filename: imageData.filename,
                        sort_index: 0,
                        product_id: productId
                    })
                });
                if (!res.ok) {
                    const data = await res.json().catch(() => ({}));
                    throw new Error(data.detail || translations.en.errorAlert);
                }
                return await res.json();
            } catch (error) {
                console.error('Error saving image to database:', error);
                throw error;
            }
        }

        function openAddProductModal(id = null) {
            editingProductId = id;
            const title = document.getElementById('productModalTitle');
            if (title) {
                title.textContent = id ? 'Edit add-on' : 'Create a new add-on';
            }
            resetProductForm();
            if (id) {
                loadProductForEdit(id);
            }
            const modal = document.getElementById("productModal");
            if (modal) modal.classList.remove("hidden");
        }

        async function loadProductForEdit(id) {
            try {
                const res = await fetch(`${API_BASE}/products/${id}`, {
                    headers: { "Authorization": `Bearer ${getToken()}` }
                });
                const p = await res.json();
                if (res.ok) {
                    document.getElementById('mainType').value = p.main_type || '';
                    document.getElementById('subType').value = p.sub_type || '';
                    document.getElementById('price').value = p.price || '';
                    document.getElementById('quantityType').value = p.quantity_type || '';
                    document.getElementById('priceStart').value = p.price_start_date || '';
                    document.getElementById('description').value = p.description || '';
                    const imageRes = await fetch(`${API_BASE}/images?product_id=${id}`, {
                        headers: { "Authorization": `Bearer ${getToken()}` }
                    });
                    const images = await imageRes.json();
                    if (imageRes.ok && images.length > 0 && imagePreview) {
                        imagePreview.src = images[0].url;
                        imagePreview.classList.remove("hidden");
                    }
                }
            } catch (error) {
                console.error('Error loading product for edit:', error);
            }
        }

        function closeProductModal() {
            const modal = document.getElementById("productModal");
            if (modal) modal.classList.add("hidden");
            resetProductForm();
        }

        function resetProductForm() {
            const form = document.getElementById("productForm");
            if (form) form.reset();
            productImageData = null;
            const imagePreview = document.getElementById("imagePreview");
            const imageFileInput = document.getElementById("imageFile");
            if (imagePreview) {
                imagePreview.src = "";
                imagePreview.classList.add("hidden");
            }
            if (imageFileInput) {
                imageFileInput.value = "";
            }
            editingProductId = null;
            const title = document.getElementById('productModalTitle');
            if (title) title.textContent = 'Create a new add-on';
        }

        const imageFileInput = document.getElementById("imageFile");
        const imagePreview = document.getElementById("imagePreview");
        if (imageFileInput) {
            imageFileInput.addEventListener("change", e => {
                const file = e.target.files && e.target.files[0];
                if (!file) {
                    productImageData = null;
                    if (imagePreview) {
                        imagePreview.src = "";
                        imagePreview.classList.add("hidden");
                    }
                    return;
                }
                const reader = new FileReader();
                reader.onload = evt => {
                    productImageData = evt.target?.result || null;
                    if (productImageData && imagePreview) {
                        imagePreview.src = productImageData;
                        imagePreview.classList.remove("hidden");
                    }
                };
                reader.readAsDataURL(file);
            });
        }

        const productForm = document.getElementById("productForm");
        if (productForm) {
            productForm.addEventListener("submit", async e => {
                e.preventDefault();
                try {
                    const t = translations.en;
                    const mainType = document.getElementById("mainType")?.value || '';
                    const subType = document.getElementById("subType")?.value || '';
                    const price = parseFloat(document.getElementById("price")?.value) || null;
                    const priceStart = document.getElementById("priceStart")?.value || null;
                    const quantityType = document.getElementById("quantityType")?.value || '';
                    const description = document.getElementById("description")?.value || '';
                    const imageFile = imageFileInput.files && imageFileInput.files[0];

                    let imageUrl = null;
                    let imageId = null;
                    if (imageFile) {
                        const imageData = await uploadImageToImageKit(imageFile);
                        imageUrl = imageData.url;
                    }

                    const method = editingProductId ? "PUT" : "POST";
                    const url = editingProductId ? `${API_BASE}/products/${editingProductId}` : `${API_BASE}/products`;
                    const productRes = await fetch(url, {
                        method,
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${getToken()}`
                        },
                        body: JSON.stringify({
                            main_type: mainType,
                            sub_type: subType,
                            price,
                            price_start_date: priceStart,
                            quantity_type: quantityType,
                            description,
                            created_by: getEmail()
                        })
                    });
                    if (!productRes.ok) {
                        const d = await productRes.json().catch(() => ({}));
                        alert(d.detail || t.errorAlert);
                        return;
                    }
                    const productData = await productRes.json();
                    const productId = productData.product_id;

                    if (imageUrl) {
                        await saveImageToDatabase(
                            { url: imageUrl, filename: imageFile.name },
                            productId,
                            mainType,
                            subType
                        );
                    }

                    closeProductModal();
                    loadProducts();
                } catch (error) {
                    console.error('Error submitting product form:', error);
                    alert(translations.en.connectionErrorAlert);
                }
            });
        }

        async function deleteProduct(id) {
            try {
                const t = translations.en;
                if (!confirm('Do you want to delete this service?')) return;
                const res = await fetch(`${API_BASE}/products/${id}`, {
                    method: "DELETE",
                    headers: { "Authorization": `Bearer ${getToken()}` }
                });
                if (!res.ok) {
                    const d = await res.json().catch(() => ({}));
                    alert(d.detail || t.errorAlert);
                    return;
                }
                loadProducts();
            } catch (error) {
                console.error('Error deleting product:', error);
                alert(translations.en.connectionErrorAlert);
            }
        }

        async function initChart() {
            try {
                const ctx = document.getElementById('revenueChart');
                if (!ctx) return;
                if (chartInstance) chartInstance.destroy();
                const res = await fetch(`${API_BASE}/all-bookings`, {
                    headers: { "Authorization": `Bearer ${getToken()}` }
                });
                const data = await res.json();
                if (!res.ok) return;
                const monthlyRevenue = Array(12).fill(0);
                data.forEach(booking => {
                    if (booking.payment_value && booking.start_date) {
                        const month = new Date(booking.start_date).getMonth();
                        monthlyRevenue[month] += parseFloat(booking.payment_value);
                    }
                });
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Revenue',
                            data: monthlyRevenue,
                            borderColor: 'rgb(2, 132, 199)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Revenue (VND)' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error initializing chart:', error);
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const userInfo = document.getElementById("userInfo");
            if (userInfo) {
                userInfo.textContent = getEmail();
            }
            initRateCalendar();
            reloadAllBookings();
            loadProducts();
            initChart();
        });
    </script>
</body>
</html>